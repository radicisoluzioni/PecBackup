version: "3.9"

services:
  pec-archiver:
    build:
      context: .
      dockerfile: Dockerfile
    image: pec-archiver:latest
    container_name: pec-archiver
    restart: unless-stopped
    environment:
      - TZ=Europe/Rome
      - PEC_ARCHIVE_CONFIG=/app/config/config.yaml
      # Add PEC passwords as environment variables
      # - PEC_PASSWORD_1=your_password_here
      # - PEC_PASSWORD_2=your_password_here
    volumes:
      # Configuration file (read-only for security)
      - ./config:/app/config:ro
      # Archive storage directory
      - /srv/pec-archive:/data/pec-archive
    # Optional: limit resources
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # REST API for searching and downloading archived emails
  pec-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    image: pec-api:latest
    container_name: pec-api
    restart: unless-stopped
    environment:
      - TZ=Europe/Rome
      - PEC_ARCHIVE_BASE_PATH=/data/pec-archive
    ports:
      # Expose API on port 8000
      - "8000:8000"
    volumes:
      # Archive storage directory (read-only for API)
      - /srv/pec-archive:/data/pec-archive:ro
    # Optional: limit resources
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.25'
    #       memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - pec-archiver
